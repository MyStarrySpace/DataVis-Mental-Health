<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Stack layout stacked bar chart</title>
		<script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
		<style type="text/css">
			.axisText path, .axisText line{
				fill: none;
				stroke: none;
			}
		</style>
	</head>
	<body>
		<script type="text/javascript">

			// Pull data from the csv files

			dataset = []

			var data_2014 = d3.csv("https://shezanmirzan.github.io/DataVis-Mental-Health/Discussion-Stacked-Barchart_View/2014-data.csv", function(data) {
				counts = [];
			    for (var i = 0; i < data.length; i++) {
			    	factors = ["mental_health_consequence", "wellness_program", "seek_help", "care_options", "leave", "anonymity", "phys_health_consequence", "benefits"];
			    	pos_values = {mental_health_consequence: ["Yes", "Maybe", "No"],
			    		wellness_program: ["Yes", "TRUE"], 
			    		seek_help: ["Yes", "TRUE"], 
			    		care_options: ["Yes", "TRUE"], 
			    		leave: ["Very easy", "Somewhat easy"], 
			    		anonymity: ["Yes", "TRUE"], 
			    		phys_health_consequence:["No", "FALSE"], 
			    		benefits: ["Yes", "TRUE"]};
			    	factor_descr = {mental_health_consequence: "Baseline; no factors selected",
				    	wellness_program: "Discussion of mental health as part of an employee wellness program",
				    	seek_help: "Resources to learn about mental health & seek help provided",
				    	care_options: "Knowledge of provided mental health care options",
				    	leave: "Availability of sick leave is easy",
				    	anonymity: "Anonymity",
				    	phys_health_consequence: "No negative consequence discussing physical health issues w/ employer",
				    	benefits: "Mental health benefits provided by employer"}
			    	for(factor of factors){
			    		if(counts[factor] == undefined){
							counts[factor] = {willing: 0, maybe: 0, not_willing: 0, factor_id: factor, factor: factor_descr[factor]}
			    		}
			    		if(pos_values[factor].includes(data[i][factor])){
			    			switch(data[i].mental_health_consequence){
			    			case "No":
			    				counts[factor].willing += 1;
			    				break;
			    			case "Maybe":
			    				counts[factor].maybe += 1;
			    				break;
			    			case "Yes":
			    				counts[factor].not_willing += 1;
			    			default:
			    				break;
			    		}
			    		}
			    	}
			    }
			    dataset = Object.values(counts);

			    generateGraphic(dataset);
			});

function generateGraphic(dataset){

			// Demonstration dataset; will be replaced by processed json data
			// var dataset = [
			// 	{ willing: 490, maybe: 477, not_willing: 292, factor_id: "mental_health_consequence", factor: "Baseline; no factors selected"},
			// 	{ willing: 4, maybe: 12, not_willing: 28, factor_id: "wellness_program", factor: "Discussion of mental health as part of an employee wellness program"},
			// 	{ willing: 8, maybe: 20, not_willing: 35, factor_id: "seek_help", factor: "Resources to learn about mental health & seek help provided"},
			// 	{ willing: 2, maybe: 19, not_willing: 32, factor_id: "care_options", factor: "Knowledge of provided mental health care options"},
			// 	{ willing: 7, maybe: 23, not_willing: 35, factor_id: "leave", factor: "Availability of sick leave is easy"},
			// 	{ willing: 23, maybe: 17, not_willing: 43, factor_id: "anonymity", factor: "Anonymity"},
			// 	{ willing: 23, maybe: 17, not_willing: 43, factor_id: "phys_health_consequence", factor: "No negative consequence discussing physical health issues w/ employer"},
			// 	{ willing: 23, maybe: 17, not_willing: 43, factor_id: "benefits", factor: "Mental health benefits provided by employer"}
			// ];

			// Set dimensions
			var w = 600;
			var h = 60 * dataset.length;
			var topMargin = 100;
			var leftMargin = 100;
			var bottomMargin = 100;
			var wordLength = 130;

			//Set up stack method
			var stack = d3.stack()
						  .keys([ "willing", "maybe", "not_willing"]);

			//Method to convert dataset to percentages
			var toPercent = function(dataset, keys){
				output = [];
				for (item in dataset){
					obj = {};
					total = 0;
					for (key of keys){
						total += dataset[item][key];
					}
					for (key of keys){
						obj[key] = dataset[item][key] / total * 100;
					}
					output[item] = obj;
				}
				return output;
			};

			datasetPercent = toPercent(dataset, ["willing", "maybe", "not_willing"]);

			//Data, stacked
			var series = stack(toPercent(dataset, ["willing", "maybe", "not_willing"]));
			
			//Set up scales
			var xScale = d3.scaleLinear()
				.domain([0,	100
				])
				.range([0, w]);

			var yScale = d3.scaleBand()
				.domain(d3.range(datasetPercent.length))
				.range([0, h])
				.paddingInner(0.2);
				
			// Set up colors
			var colors = d3.scaleOrdinal(datasetPercent).range(["#B1F68A", "#FFFC80", "#FD97AC"]);
		
			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w + leftMargin + wordLength)
						.attr("height", h + topMargin + bottomMargin);

			// Chart Title
			svg.append("text")
				.attr("x", ((w + leftMargin) / 2))             
		        .attr("y", 25)
		        .attr("text-anchor", "middle")  
		        .style("font-size", "20px") 
		        .style("font-weight", "bold") 
				.text("Effects of factors on perception of negative consequences discussing mental health");

            // Chart subtitles
            svg.append("text")
		        .attr("x", (w / 2))             
		        .attr("y", -34)
		        .attr("text-anchor", "middle")  
		        .style("font-size", "16px") 
		        .style("text-decoration", "underline")  
		        .text("Perception of consequence")
		        .attr("transform", "translate(" + (wordLength / 2 + leftMargin) + ", " + topMargin + ")");

		     svg.append("text")
		        .attr("x", 0)             
		        .attr("y", (h / 2))  
		        .style("font-size", "16px") 
		        .style("text-decoration", "underline")  
		        .text("Factors")
		        .attr("transform", "translate(" + 0 + ", " + topMargin + ")");

			// Add a group for each row of data
			var groups = svg.selectAll("g")
				.data(series)
				.enter()
				.append("g")
				.style("fill", function(d, i) {
					return colors(i);
				})
				.attr("class", function(d, i){
					return ["willing", "maybe_willing", "not_willing"][i];
				})
				.attr("transform", "translate(" + (wordLength + leftMargin) + ", " + topMargin + ")");

			// Create feature labels (y axis)
			var scale = d3.scaleOrdinal()
                .domain([d3.min(datasetPercent), d3.max(datasetPercent)])
                .range(Array.from({length: datasetPercent.length},(v,k)=> yScale(k) + 5));

            var y_axis = d3.axisLeft()
                  .scale(scale);

            scale.domain(dataset.map(function(d) { 
            	return d.factor; }));

			svg.append("g")
				.attr("class", "axisText")
            	.call(y_axis)
            	.selectAll("text")
            	.call(wrap, wordLength)
            	.attr("transform", "translate(" + (wordLength - 10 + leftMargin) + ", " + topMargin + ")")
            	.style("font-size", "12px") 
            	.style("opacity","0")
				.transition()
				.delay((function(d, i) { return(i * 150); }))
				.duration(1000)
				.style("opacity","1");
			
			var drawMiddleRects = function(){
				// Add lines through middle rectangles
				var middle_rects = groups._groups[0][1].getElementsByTagName("rect");
				for(rect of middle_rects){
					groups.append("line")
						.attr("x1", rect.x.animVal.value + (rect.width.animVal.value / 2))
						.attr("x2", rect.x.animVal.value + (rect.width.animVal.value / 2))
						.attr("y1", rect.y.animVal.value)
						.attr("class", "middleLine")
						.attr("stroke-width", 2)
						.attr("stroke", "#7F7F7F")
						.style("opacity", "0")
						.transition()
						.duration(1000)
						.style("opacity", "1")
						.attr("y2", rect.y.animVal.value + rect.height.animVal.value)
				}
			}

			// Add a rect for each data value
			var rects = groups.selectAll("rect")
				.data(function(d) { 
					return d; })
				.enter()
				.append("rect")
				.attr("y", function(d, i) {
					return yScale(i);
				})
				.attr("x", function(d) {
					return xScale(d[0]);
				})
				.transition()
		      	.duration(1000)
				.attr("width", function(d) {
					return xScale(d[1]) - xScale(d[0]);
				})
				.attr("height", yScale.bandwidth())
				.on("end", drawMiddleRects);

			// Stylize first bar differently
			try{
				groups._groups[0][0].getElementsByTagName("rect")[0].setAttribute("style", "fill: #309603;")
				groups._groups[0][0].getElementsByTagName("rect")[0].setAttribute("class", "firstRowRect")
				groups._groups[0][1].getElementsByTagName("rect")[0].setAttribute("style", "fill: #FFF020;")
				groups._groups[0][1].getElementsByTagName("rect")[0].setAttribute("class", "firstRowRect")
				groups._groups[0][2].getElementsByTagName("rect")[0].setAttribute("style", "fill: #FB0017;")
				groups._groups[0][2].getElementsByTagName("rect")[0].setAttribute("class", "firstRowRect")
			}
			catch(err){
				console.log("Error with stylizing first bar");
			}

			// Add bar text
			var barText = groups.selectAll(".text")
				.data(function(d) {
					return d; })
				.enter()
				.append("text")
				.attr("class","label")
				.attr("x", (function(d) { return xScale(d[0]) + 5; }))
				.attr("y", (function(d, i) { return yScale(i) + 15; }))
				.attr("dy", ".75em")
				.text(function(d) { return Math.round(d[1] - d[0]) + "%"; })
				.style("fill", "#000000")
				.style("opacity","0")
				.transition()
				.duration(1000)
				.style("opacity","1");

			// Add top label text
			var topRect = svg.selectAll(".firstRowRect");
			for(rect of topRect._groups[0]){ 
				svg.append("text").attr("class", "topLabel");
			}
			var topLabelText = svg.selectAll(".topLabel")
				.data(series)
				.text(function(d, i) { return(["None", "Maybe consequence", "Consequence"][i]); })
				.attr("class", function(d, i){
					return ["willing", "maybe_willing", "not_willing"][i];
				})
				.attr("x", (function(d, i) { return(xScale(d[0][0]) + 5); }))
				.attr("y", "-20")
				.attr("dy", ".75em")
				.attr("transform", "translate(" + (wordLength - 5 + leftMargin) + ", " + topMargin + ")")
				.style("opacity","0")
				.transition()
				.delay((function(d, i) { return(i * 250); }))
				.duration(1000)
				.style("opacity","1");

			// Wrap feature text
			function wrap(text, width) {
			  text.each(function() {
			    var text = d3.select(this),
			        words = text.text().split(/\s+/).reverse(),
			        word,
			        line = [],
			        lineNumber = 0,
			        lineHeight = 1.1, // ems
			        y = text.attr("y"),
			        dy = parseFloat(text.attr("dy")),
			        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
			    while (word = words.pop()) {
			      line.push(word);
			      tspan.text(line.join(" "));
			      if (tspan.node().getComputedTextLength() > width) {
			        line.pop();
			        tspan.text(line.join(" "));
			        line = [word];
			        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", lineHeight + dy + "em").text(word);
			      }
			    }
			  });
			}

			// Add interactivity upon highlight
			svg.selectAll(".willing")
				.on("mouseover", function(d) {
					d3.selectAll(".maybe_willing").transition().style("opacity", 0.2);
					d3.selectAll(".not_willing").transition().style("opacity", 0.2);
				})
				.on("mouseout", function(d) {
					d3.selectAll(".maybe_willing").transition().style("opacity", 1);
					d3.selectAll(".not_willing").transition().style("opacity", 1);
				});

			svg.selectAll(".maybe_willing")
				.on("mouseover", function(d) {
					d3.selectAll(".willing").transition().style("opacity", 0.2);
					d3.selectAll(".not_willing").transition().style("opacity", 0.2);
				})
				.on("mouseout", function(d) {
					d3.selectAll(".willing").transition().style("opacity", 1);
					d3.selectAll(".not_willing").transition().style("opacity", 1);
				});

			svg.selectAll(".not_willing")
				.on("mouseover", function(d) {
					d3.selectAll(".willing").transition().style("opacity", 0.2);
					d3.selectAll(".maybe_willing").transition().style("opacity", 0.2);
				})
				.on("mouseout", function(d) {
					d3.selectAll(".willing").transition().style("opacity", 1);
					d3.selectAll(".maybe_willing").transition().style("opacity", 1);
				});

			}
						
		</script>


	</body>
</html>